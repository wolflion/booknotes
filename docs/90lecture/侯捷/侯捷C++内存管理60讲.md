### 1、Overview

+ GNU 4.9.2源代码
+ gee.cs.oswego.edu/dl，**作者从1986年开始研究malloc算法**

### 2、内存分配的每一层面

+ 天宝当年，DOS 640K，and extented memory

+ *80286、80386*

### 3、四个层面的基本用法

### 4、基本构件之一newdelete expression上

+ new干了2件事：**分配内存，分配好后，调用构造函数**

+ `Complex *pc = new Complex(1,2);`

```c++
 Complex *pc;
try{
    //operator new能被重载，*能理解，new本身是个运算符* 【operator new源码实现在newop2.cpp】
    void *mem=operator new(sizeof(Complex));//allocate
    pc=static_cast<Complex*>(mem);//cast
    //通过指针，调用构造函数【注意：只有编译器才可以直接调用ctor】
    pc->Complex::Complex(1,2);//construct
    //注意：只有编译器才可以像上面那样直接呼叫ctor
}
catch(std::bad_alloc){
    //若allocation失败就不执行constructor
}
```

+ 想直接调用ctor，可用placement new：`new(p)Complex(1,2);`
+ **std::nothrow**的名词解释

### 10、重载示例（上）

+ `operator new/operator delete`
+ 写个demo，
  + （1）看下`::new(7)`和`new Foo(7)`对比下两个的区别，在vs环境中。
  + （2）看下，`~Foo()`dtor 加不加`virtual`除了`sizeof()`不同外，还有啥区别

```cpp
class Foo{
public:
    int _id;
    long _data;
    string _str;
public:
    Foo::_id(0){cout<<"default ctor.this="<<this<<"id="_id<<endl;}
    Foo(int i):id(i){cout<<"ctor.this="<<this<<"id="<<_id<<endl;}
//virtual
    ~Foo() {cout<<"dtor.this="<<this<<"id="<<_id<<endl;}
    static void *operator new(size_t size);
    static void operator delete(void* pdead, size_t size);
    static void *operator new[](size_t size);
    static void operator delete[](void* pdead, size_t size);
}

void *Foo::operator new(size_t size) {
    Foo *p = (Foo*)malloc(size);
    cout<<"...";
    return p;
}
void Foo::operator delete(void* pdead, size_t size) {
    cout<<"...";
    free(pdead);
}
void *Foo::operator new[](size_t size) {
    Foo *p = (Foo*)malloc(size);
    cout<<"...";
    return p;
}
void Foo::operator delete[](void* pdead, size_t size) {
    cout<<"...";
    free(pdead);
}

//使用场景
Foo *pf = new Foo;
delete pf;

//若无members就调用globals
Foo*pf = ::new Foo; // void* ::operator new(size_t);
::delete pf; //void ::operator delete(void*);

//demo
cout<<"sizeof(Foo)"<<sizeof(Foo)<<endl;
Foo*p = new Foo(7);
delete p;

Foo *pArray = new Foo[5];
delete []pArray;
```

