## 缘起

+ 《Linux内核源码剖析-tcpip实现(下)》的chap26，27的内容
+ 2024W17看了一下书的内容，04-26有意识的串一下吧，花了1个cubi时再对着看，*由于不太懂，整理得还是有点粗糙，但先这样吧*

## 内容

### 2.1、理论初步

#### 2.1.1、TCP控制块

+ *有点类似于 进程控制块PCB一样*
+ 从建立连接、传输、连接终止分别定义了几种，*至少是3种啊*
  + 面向连接，tcp_request_sock，chap28
  + 传输，tcp_sock
    + inet_connection_sock，**基于inet_sock**
    + **基于inet_connection_sock**，增加了一些**拥塞、滑动窗口**，*自己，是不是真正懂了这些机制？我还不太懂*
    + *其它的一些，结构体细节，没看*
  + 终止，tcp_timewait_sock，chap32

#### 2.1.2、TCP状态迁移图

+ 网上找了一个[链接](TCP状态转换图总结)
+ *至少目前，我还不太清楚，怎么找个方式去记它呢*
  + 它的主线其实还是**三次握手，四次挥后**吧

#### 2.1.3、TCP首部，校验和

+ TCP首部，就不记了
+ 校验和，跟UDP的区别，**覆盖TCP首部和数据**

#### 2.1.4、控制块管理和缓存的管理

+ *这部分没太整明白*
+ 缓存管理
  + 无非就是**分配与回收**，*但具体细节要看下代码*

### 2.2、代码结构

#### 2.2.1、inet_protosw结构

+ 指定了协议，`IPPROTO_TCP`

#### 2.2.2、net_protocol结构

+ 实例化了`tcp_protocol`，会定义了`.handler = tcp_v4_rcv,`

#### 2.2.3、tcp_sock结构

+ *如果有可能，是不是要把 各个字段，大概搞清楚是啥意思*，要对着代码看一下

#### 2.2.4、tcp_prot

+ 传输层接口

### 2.3、关键函数

#### 2.3.1、tcp_init()

+ *这部分还是要自己读代码*，然后去搜结构体，多搞几回，加深印象，*目前自己电脑环境上还没有代码，先建立印象吧，H2开始整理代码*

#### 2.3.2、tcp_v4_err()

### 2.4、定时器

+ *之前都不知道这个，看了下《TCPIP详解》里好像也没提到嘛*，于是自己网上搜了一下

#### 2.4.1、理论

+ 目前有7个定时器（一般只有4个，**记住各自的激活场景**）
  + 连接建立
  + 重传
  + 延时ACK
  + 持续
  + 保活
  + FIN_WAIT_2
  + TIME_WAIT
+ **TCP的可靠性，是靠定时器实现的**，比如说*超时多久没收到，就丢弃，这里面就有个定时器*

#### 2.4.2、代码

+ *暂未看*，书上的整理结构都比较单一，**每个定时器的处理函数是啥，会在啥状态下被激活**，*自己还没整那么细，主要概念还没弄清楚呢，后面再详解弄明白*

## 最后

+ *整体，自己目前也学得云里雾里*
+ 相当于就是**TCP的介绍**，后面的28-32章
  + 28，连接
  + 29，拥塞控制
  + 30，输出
  + 31，输入
  + 32，终止
+ 《深入Linux内核架构》12.9.1传输层的TCP
  + 2、接收TCP数据，tcp_v4_rcv  【相当于31章的输入】
  + 4、被动连接建立
  + 5、主动连接建立（都在28章）
    + tcp_connect
  + 6、分组传输
  + 7、接收分组
  + 8、发送分组，tcp_sendmsg
  + 9、连接终止