## 《Linux内核源代码剖析-TCP/IP实现》

+ 2.6.20代码
+ https://lxr.missinglinkelectronics.com/
+ 上册（1-19章）

### chap1、预备知识

#### 1.1、应用层配置诊断工具

##### 1.1.1、iputils

##### 1.1.2、net-tools

##### 1.1.3、iproute2

#### 1.2、内核空间与用户空间的接口

##### 1.2.1、procfs

##### 1.2.2、sysctl(/proc/sys目录)

##### 1.2.3、sysfs(/sys文件系统)

##### 1.2.4、ioctl系统调用

##### 1.2.5、netlink套接口

#### 1.3、网络I/O加速

##### 1.3.1、TSO/GSO

##### 1.3.2、I/O AT

#### 1.4、其他

##### 1.4.1、slab分配器

##### 1.4.2、RCU

### chap2、网络体系结构概述

+ *感觉目录，是从上层往下层的，lionel*

2.1、引言

2.2、协议简介

2.3、网络架构

2.4、系统调用接口

2.5、协议无关接口

2.6、传输层协议

2.7、套接口缓存

#### 2.8、设备无关接口

+ 提供一组**通用接口**，供底层网络设备驱动程序和上层协议调用
+ **协议栈向设备发送数据包**时需要调用`dev_queue_xmit()`，该函数对SKB进行排队，真正传输还是底层设备驱动程序
+ **底层设备驱动程序接收报文**是调用`netif_rx()`将SKB上传到网络层。
+ **NAPI技术**

#### 2.9、设备驱动程序

+ net_device结构，有个`hard_start_xmit()`接口

#### 2.10、网络模块源代码组织

+ drivers
  + net
+ net
  + bridge
  + core
  + ethernet
  + ipv4
  + netlink
+ include
  + linux
  + net
  + asm-xxx

### chap3、套接口缓存（sk_buff）

#### 3.1、引言

+ 网络协议中的操作对系统的存储和设计有要求
  + 处理**变长缓存**，接收和发送的数据报长度不是固定的
  + 容器在头尾部添加和移除数据，因为需要在不同网络层次间进行数据传递
  + 在添加和移除数据时能够尽量避免数据的复制
+ 套接口缓存（socket buffer）
+ **SKB的主要用途**：保存在进程和网络接口之间互相传递的用户数据，以及其他一些信息

+ include/linux/[skbuff.h](https://lxr.missinglinkelectronics.com/linux+v2.6.24/include/linux/skbuff.h)，SKB结构定义和宏
+ net/core/[skbuff.c](https://lxr.missinglinkelectronics.com/linux+v2.6.24/net/core/skbuff.c)，操作SKB的函数

#### 3.2、sk_buff结构

##### 0、

+ **已接收或待发送的数据报文消息**，分为以下几类
  + 与SKB组织相关的成员变量
  + 通用成员变量
  + 标志性变量
  + 与特性相关的成员变量
+ **添加首部，比拷贝数据效率高**，`skb_reserve()`先预留

##### 3.2.1、网络参数和内核数据结构

##### 3.2.2、SKB组织相关的变量

+ 用来构成SKB双向链表

3.2.3、数据存储相关的变量

3.2.4、通用的成员变量

3.2.5、标志性变量

3.2.6、特性相关的成员变量

#### 3.3、skb_shared_info结构

##### 0、

##### 3.3.1、“零拷贝”技术

3.3.2、对聚合分散I/O数据的支持

3.3.3、对GSO的支持

3.3.4、访问skb_shared_info结构

#### 3.4、管理函数

##### 0、

+ **不要直接调用`__do_something()`这种，而是用`do_something()`**，*有`__`开头的函数，lionel*

3.4.1、SKB的缓存池

##### 3.4.2、分配SKB

+ 1、
+ 2、dev_alloc_skb()

3.4.3、释放SKB

3.4.4、数据预留和对齐

3.4.5、克隆和复制SKB

3.4.6、链表管理函数

3.4.7、添加或删除尾部数据

3.4.8、拆分数据：skb_split()

3.4.9、重新分配SKB的线性数据区：pskb_expand_head()

3.4.10、其他函数

### chap4、网络模块初始化

#### 4.1、引言

#### 4.2、网络模块初始化顺序

#### 4.3、优化基于宏的标记

#### 4.4、网络设备处理层初始化