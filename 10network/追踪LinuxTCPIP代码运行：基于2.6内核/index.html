<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>追踪LinuxTCPIP代码运行：基于2.6内核 - lionel的技术笔记</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u8ffd\u8e2aLinuxTCPIP\u4ee3\u7801\u8fd0\u884c\uff1a\u57fa\u4e8e2.6\u5185\u6838";
        var mkdocs_page_input_path = "10network\\\u8ffd\u8e2aLinuxTCPIP\u4ee3\u7801\u8fd0\u884c\uff1a\u57fa\u4e8e2.6\u5185\u6838.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> lionel的技术笔记
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">简介</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../01daily/">daily</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../02ds/">ds</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../03cpp/">cpp</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../21tool/">tool</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">C++</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../20C%2B%2B/effectiveC%2B%2B/">《Effective C++》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../20C%2B%2B/%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2C%2B%2B%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B/">《深度探索C++对象模型》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../21STL/EffectiveSTL/">《Effective STL》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../21STL/C%2B%2B%E6%B3%9B%E5%9E%8BSTL%E5%8E%9F%E7%90%86%E5%92%8C%E5%BA%94%E7%94%A8/">《C++泛型STL原理和应用》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../21STL/STL%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/">《STL源码剖析》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../22C%2B%2Bmodern/%E6%B7%B1%E5%85%A5%E5%BA%94%E7%94%A8C%2B%2B11/">《深入应用C++11》</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">基础知识</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../408/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/">《操作系统导论》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../408/%E5%A4%A7%E8%AF%9D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">《大话设计模式》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../408/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90_C%2B%2B4th/">《数据结构与算法分析_C++4th》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../408/%E7%AE%97%E6%B3%95%284th%29/">《算法4th》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../408/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90-%E5%BC%A0%E5%86%9B/">《算法设计与分析-张军》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../408/%E5%A4%A9%E8%A1%8C-%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/">《天行-算法设计与实现》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../408/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%95%99%E7%A8%8B-%E6%9D%8E%E6%98%A5%E8%91%86/">《数据结构教程》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../408/%E6%96%B0%E7%BC%96%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%A0%E9%A2%98%E4%B8%8E%E8%A7%A3%E6%9E%90/">《新编数据结构习题与解析》</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">网络编程</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../TCPIP%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">《TCP/IP网络编程》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Linux%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B/">《Linux高性能服务器编程》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../TCPIP%E8%AF%A6%E8%A7%A3%E5%8D%B71/">《TCPIP详解卷1》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Linux%E5%86%85%E6%A0%B8%E7%BD%91%E7%BB%9C%E6%A0%88%E6%BA%90%E4%BB%A3%E7%A0%81%E6%83%85%E6%99%AF%E5%88%86%E6%9E%90/">《Linux内核网络栈源代码情景分析》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Linux%E7%BD%91%E7%BB%9C/">《深入理解Linux网络》</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">机器&深度学习</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../30machineLearning/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0%E5%9F%BA%E7%A1%80/">《机器学习线性代数基础》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../31deepLearning/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%85%A5%E9%97%A8%EF%BC%9A%E5%9F%BA%E4%BA%8EPython%E7%9A%84%E7%90%86%E8%AE%BA%E4%B8%8E%E5%AE%9E%E7%8E%B0/">《深度学习入门：基于Python的理论与实现》</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">文件系统</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../11filesystem/Linux%E5%86%85%E6%A0%B8%E6%8E%A2%E7%A7%98/">《Linux内核探秘》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../11filesystem/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95/">《文件系统技术内幕》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../11filesystem/%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">《存储技术原理分析》</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">存储</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../12storage/ceph%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E7%8E%B0/">《ceph设计原理与实现》</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">视频</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../14video/FFmpeg%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/">《FFmpeg入门到精通》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../14video/WebRTC%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97/">《WebRTC权威指南》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../14video/WebRTC%E9%9F%B3%E8%A7%86%E9%A2%91%E5%AE%9E%E6%97%B6%E4%BA%92%E5%8A%A8%E6%8A%80%E6%9C%AF/">《WebRTC音视频实时互动技术》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../14video/%E6%96%B0%E4%B8%80%E4%BB%A3%E8%A7%86%E9%A2%91%E5%8E%8B%E7%BC%A9%E7%A0%81%E6%A0%87%E5%87%86-H.264_AVC/">《新一代视频压缩码标准-H.264_AVC》</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">内核</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../13kernel/Linux%E5%86%85%E6%A0%B8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/">《Linux内核设计与实现》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../13kernel/%E6%B7%B1%E5%85%A5Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F%E5%86%85%E6%A0%B8%E6%9C%BA%E5%88%B6/">《深入Linux设备驱动程序内核机制》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../13kernel/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Linux%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">《深入理解Linux虚拟内存管理》</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../13kernel/深入理解Linux网络技术内幕.md">《深入理解Linux网络技术内幕》</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../13kernel/Linux内核源代码剖析-tcpip实现.md">《Linux内核源代码剖析-TCP/IP实现》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../13kernel/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Linux%E5%86%85%E6%A0%B8/">《深入理解Linux内核》</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">工具</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../15tool/Wireshark%E7%BD%91%E7%BB%9C%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98/">《Wireshark网络分析实战》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../15tool/Linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%8Eshell%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B%E5%A4%A7%E5%85%A8%283rd%29/">《Linux命令行与shell脚本编程大全(3rd)》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../15tool/python%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%EF%BC%883rd%EF%BC%89/">《python程序设计（3rd）》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../15tool/python/Python%E7%BC%96%E7%A8%8B%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E8%B7%B5/">《Python编程从入门到实践》</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">刷题</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../91leetcode/%E5%89%91%E6%8C%87offer2nd/">《剑指offer2nd》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../91leetcode/%E5%89%91%E6%8C%87offer%E4%B8%93%E9%A1%B9%E7%AA%81%E7%A0%B4/">《剑指offer专项突破》</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../96output/OD基础题.md">OD基础题</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../96output/OD进阶题.md">OD进阶题</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">网课</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../90lecture/01Linux%E9%AB%98%E5%B9%B6%E5%8F%91%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%BC%80%E5%8F%91/">《Linux高并发网络编程开发》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../90lecture/%E4%BE%AF%E6%8D%B7/%E4%BE%AF%E6%8D%B7C%2B%2B%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%8660%E8%AE%B2/">《侯捷C++内存管理60讲》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../90lecture/11NJU%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90/">《NJU算法设计与分析》</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">英语专</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../60English/00794%E7%BB%BC%E5%90%88%E8%8B%B1%E8%AF%AD%E4%B8%80%E4%B8%8A/">《综合英语(一)上》</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../95selfStudy/%E6%A6%82%E7%8E%87%E8%AE%BA%E4%B8%8E%E6%95%B0%E7%90%86%E7%BB%9F%E8%AE%A1/">《概率率与数理统计》</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">lionel的技术笔记</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>追踪LinuxTCPIP代码运行：基于2.6内核</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="linux-tcpip26">《追踪Linux TCP/IP代码运行：基于2.6内核》<a class="headerlink" href="#linux-tcpip26" title="Permanent link">&para;</a></h2>
<ul>
<li>2.6.26内核</li>
</ul>
<h3 id="chap1">chap1、本书的计划<a class="headerlink" href="#chap1" title="Permanent link">&para;</a></h3>
<h4 id="11">1.1、基本路线和要求<a class="headerlink" href="#11" title="Permanent link">&para;</a></h4>
<h5 id="113">1.1.3、分析路线<a class="headerlink" href="#113" title="Permanent link">&para;</a></h5>
<ul>
<li><strong>通过socket程序全面掌握整个网络的工作过程</strong></li>
</ul>
<ul>
<li>服务端执行路线<ul>
<li>socket，bind，listen【与connect】，accept，read【对应write】，write【对应read】，close</li>
<li><em>就是socket后，bind啥？，listen【监听有哪些连接】，把它们接收过来accept，再read/wirte后，关闭close</em></li>
</ul>
</li>
<li>客户端执行路线<ul>
<li>socket，connect【与listen】，write【与read】，read【与wirte】，close</li>
<li><em>简单的说，就是socket，然后connnect，再write/read，最后close</em></li>
</ul>
</li>
<li>代码1.1<ul>
<li><em>最后要close掉2个fd，也就是有多少个fd，就需要close掉多少？</em></li>
</ul>
</li>
</ul>
<p>1.2、TCP/IP协议层的划分与基本知识</p>
<h4 id="13">1.3、函数到系统调用的过程<a class="headerlink" href="#13" title="Permanent link">&para;</a></h4>
<h4 id="14">1.4、网络文件系统<a class="headerlink" href="#14" title="Permanent link">&para;</a></h4>
<ul>
<li>net/socket.c中的<code>sock_fs_type</code><ul>
<li>此处是<strong>虚拟文件系统</strong></li>
<li><em>虚拟文件系统，与，file_system_type的意义，自己可以搜一下，本处不是重点</em></li>
</ul>
</li>
</ul>
<pre class="highlight"><code class="language-c">static struct file_system_type sock_fs_type = {
    .name = "sockfs";
    .get_sb = sockfs_get_sb;
    .kill_sb = kill_anon_super,
};</code></pre>
<ul>
<li>启动时，init/main.c中的<code>kernel_init()</code>，继续调用<code>do_basic_setup()</code>，从而调用<code>do_initcalls()</code>来执行所有的init初始化函数</li>
<li><strong>do_one_initcall()机制</strong>，<em>这部分，没怎么看</em></li>
<li>驱动程序中常用的module_init也是<strong>通过initcall来实现的</strong></li>
<li><code>sock_init()</code>注册成功后，内核初始化会执行它，来登记网络文件系统</li>
</ul>
<pre class="highlight"><code class="language-c">register_filesystem(&amp;sock_fs_type);
sock_mnt = kern_mount(&amp;sock_fs_type);//安装网络文件系统</code></pre>
<ul>
<li><strong>调用数据结构（sock_fs_type）中的钩子函数<code>get_sb()</code></strong></li>
<li><code>get_sb_pseudo()</code>·调用<strong>超级块操作函数<code>sockfs_ops</code>的</strong></li>
</ul>
<pre class="highlight"><code class="language-c">static struct super_operations sockfs_ops = {
    .alloc_inode = sock_alloc_inode,
    .destroy_inode = sock_destroy_inode,
    .statfs = simple_statfs,
};</code></pre>
<h3 id="chap2socket">chap2、socket的创建<a class="headerlink" href="#chap2socket" title="Permanent link">&para;</a></h3>
<h4 id="0">0、自己疑问<a class="headerlink" href="#0" title="Permanent link">&para;</a></h4>
<ul>
<li>2.3的协议族，在api用时，表示啥意思，在kernel层，比较难看得懂</li>
<li>2.4能理解，<strong>分配</strong>是sk_alloc()，<strong>初始化</strong>是<code>sock_init_data()</code></li>
</ul>
<h4 id="21">2.1、本章几个重要数据结构<a class="headerlink" href="#21" title="Permanent link">&para;</a></h4>
<ul>
<li>1、socket结构的定义<ul>
<li>include/linux/net.h中的<code>struct socket{};</code></li>
</ul>
</li>
<li>2、sock结构的定义<ul>
<li>也是net.h的吗？ <code>struct sock{};</code></li>
</ul>
</li>
<li><strong>公用是socket结构，通用是sock结构，专用是具体协议族</strong></li>
<li>3、sk_buff结构的定义<ul>
<li>也是net.h的吗？<code>struct sk_buff{};</code></li>
</ul>
</li>
<li>4、tcp_sock结构</li>
<li><strong>在“用中理解”的方式</strong><ul>
<li>先编写函数，还是先编写结构</li>
<li><strong>逆向推理结构体是因何产生、因何而用</strong>，这种方式能提高了理解、阅读代码的水平，更能增强逻辑思维的能力</li>
</ul>
</li>
</ul>
<h4 id="22socket">2.2、分配并初始化socket结构<a class="headerlink" href="#22socket" title="Permanent link">&para;</a></h4>
<ul>
<li>net/socket.c中的<code>sys_socketcall()-&gt;sys_socket()-&gt;sock_create()-&gt;__sock_create()</code><ul>
<li><code>sock_alloc()</code><ul>
<li><code>SOCKET_I()</code></li>
<li><code>new_inode()</code><ul>
<li><code>alloc_inode()-&gt;sock_alloc_inode()</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="23socket">2.3、使用协议族的函数表初始化socket<a class="headerlink" href="#23socket" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>AF_INET</strong>，net/ipv4/af_inet.c中</li>
</ul>
<h4 id="24sock">2.4、分配并初始化sock结构<a class="headerlink" href="#24sock" title="Permanent link">&para;</a></h4>
<ul>
<li>分配sock结构是代码，<code>sk = sk_alloc(net,PF_INET,GFP_KERNEL,answer_prot);</code></li>
</ul>
<ul>
<li><code>__sock_create()-&gt;inet_create()-&gt;sk_alloc()</code><ul>
<li><code>sk_prot_alloc()</code></li>
<li><code>sock_lock_init()</code></li>
</ul>
</li>
<li><code>__sock_create()-&gt;inet_create()-&gt;sock_init_data()</code></li>
</ul>
<h4 id="25tcpsock">2.5、TCP协议对sock结构初始化<a class="headerlink" href="#25tcpsock" title="Permanent link">&para;</a></h4>
<ul>
<li><code>if(sk-&gt;sk_prot-&gt;init){ err = sk-&gt;sk_prot-&gt;init(sk);}</code>，<strong>这里调用了运输层的钩子函数<code>init()</code></strong>，这里需要结合<strong>结构体tcp_prot</strong>来看</li>
</ul>
<h4 id="26socket">2.6、socket与文件系统的关联<a class="headerlink" href="#26socket" title="Permanent link">&para;</a></h4>
<ul>
<li>用<code>retval = sock_map_fd(sock)</code>来完成收尾工作</li>
</ul>
<ul>
<li><code>sys_socketcall()-&gt;sys_socket()-&gt;sock_map_fd()</code><ul>
<li>48（59/596），tcp_sock结构的关联图</li>
<li><code>sock_alloc_fd()</code></li>
<li><code>sock_attach_fd()</code></li>
</ul>
</li>
<li><strong>socket_file_ops结构体</strong></li>
</ul>
<h3 id="chap3socket">chap3、socket地址设置<a class="headerlink" href="#chap3socket" title="Permanent link">&para;</a></h3>
<h4 id="31">3.1、地址设置接口<a class="headerlink" href="#31" title="Permanent link">&para;</a></h4>
<ul>
<li><em>为什么server端要调用bind()</em></li>
</ul>
<h4 id="32">3.2、地址结构定义<a class="headerlink" href="#32" title="Permanent link">&para;</a></h4>
<ul>
<li><em>struct sockaddr_in与struct sockaddr能相互转换不？</em></li>
</ul>
<h4 id="33">3.3、地址类型<a class="headerlink" href="#33" title="Permanent link">&para;</a></h4>
<h4 id="34">3.4、设置地址和端口<a class="headerlink" href="#34" title="Permanent link">&para;</a></h4>
<h4 id="35init_net">3.5、网络空间总管init_net<a class="headerlink" href="#35init_net" title="Permanent link">&para;</a></h4>
<ul>
<li><code>net_ns_init()</code></li>
</ul>
<h3 id="chap4">chap4、路由<a class="headerlink" href="#chap4" title="Permanent link">&para;</a></h3>
<h4 id="41">4.1、路由函数表结构及关系图<a class="headerlink" href="#41" title="Permanent link">&para;</a></h4>
<ul>
<li>路由函数表fib_table是路由的总根，可以从它出发找到各个路由区结构fn_zone，也可以找到路由节点结构fib_node或者路由信息结构fib_info。</li>
</ul>
<h4 id="42">4.2、路由函数表的初始化<a class="headerlink" href="#42" title="Permanent link">&para;</a></h4>
<ul>
<li><code>inet_init</code>调用了<code>ip_init()</code>，进一步调用了<code>ip_rt_init()</code></li>
<li><em>不少重点，没看</em></li>
</ul>
<h4 id="43">4.3、通过路由函数表查找路由信息<a class="headerlink" href="#43" title="Permanent link">&para;</a></h4>
<ul>
<li>通过<code>_inet_dev_addr_type()</code>的过程中来看调用函数表<code>tb_lookup()</code></li>
</ul>
<h4 id="44">4.4、路由的设置及相关结构的初始化<a class="headerlink" href="#44" title="Permanent link">&para;</a></h4>
<ul>
<li>A、net_tools通过ioctl系统调用进入<code>ip_rt_ioctl()</code>，它通过<strong>路由函数表的钩子函数</strong>实现增加或者删除路由</li>
<li>B、iproute2设置路线，它设置路由的方式主要是通过netlink来实现，调用<code>inet_rtm_newroute()</code>或者<code>inet_rtm_delroute()</code></li>
<li>C、通知链的方式，在<code>ip_fib_init()</code></li>
</ul>
<h4 id="45">4.5、基于输出方向的路由表查找与创建<a class="headerlink" href="#45" title="Permanent link">&para;</a></h4>
<ul>
<li><code>sys_socketcall()-&gt;sys_connect()-&gt;inet_stream_connect()-&gt;tcp_v4_connect()-&gt;ip_route_connect()</code></li>
</ul>
<h4 id="46">4.6、基于输入方向的路由表查找与创建<a class="headerlink" href="#46" title="Permanent link">&para;</a></h4>
<ul>
<li><code>do_softirq()-&gt;net_rx_action()-&gt;process_backlog()-&gt;netif_receive_skb()-&gt;deliver_skb()-&gt;ip_rcv()-&gt;ip_rcv_finish()-&gt;ip_route_input()</code></li>
</ul>
<h3 id="chap5">chap5、通知链<a class="headerlink" href="#chap5" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>内核为了及时响应某些到来的事件，采取了通知链的方式来执行指定函数</strong></li>
</ul>
<pre class="highlight"><code class="language-cpp">struct notifier_block{
    //notifier_call函数指针，表示通知链节点要运行的函数
    int(*notifier_call)(struct notifier_block *, unsigned long, void *);//通知调用的函数
    struct notifier_block *next;//指向下一个通知节点，从而组成链队
    int priority;//优先级
};</code></pre>
<h4 id="51">5.1、设备通知链节点的挂入<a class="headerlink" href="#51" title="Permanent link">&para;</a></h4>
<ul>
<li>利用<code>devinet_init()</code>，调用<code>register_netdevice_notifier()</code>将节点结构<code>ip_netdev_notifier</code>挂入内核的设备通知链netdev_chain队列中</li>
</ul>
<h4 id="52">5.2、地址通知链节点的挂入<a class="headerlink" href="#52" title="Permanent link">&para;</a></h4>
<ul>
<li><code>ip_fib_init()</code>调用<code>register_inetaddr_notifier()</code>通知链节点<code>fib_inetaddr_notifier</code></li>
</ul>
<h4 id="53">5.3、通知链的调用和执行<a class="headerlink" href="#53" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>内核中有一个专门调用通知链函数<code>notifier_call_chain()</code></strong></li>
</ul>
<h3 id="chap6netlink">chap6、netlink链<a class="headerlink" href="#chap6netlink" title="Permanent link">&para;</a></h3>
<p>6.1、netlink的创建</p>
<p>6.2、注册路由的netlink</p>
<p>6.3、通过netlink通信 </p>
<h3 id="chap7">chap7、监听连接请求<a class="headerlink" href="#chap7" title="Permanent link">&para;</a></h3>
<p>7.1、内核的监听函数</p>
<p>7.2、内核的监听队列</p>
<h3 id="chap9">chap9、准备连接请求<a class="headerlink" href="#chap9" title="Permanent link">&para;</a></h3>
<p>9.1、内核的连接函数</p>
<p>9.2、分配数据包结构和数据块空间</p>
<p>9.3、构建、发送TCP数据包</p>
<p>9.4、进化成IP数据包</p>
<p>9.5、进化成以太网数据包</p>
<p>9.6、发送以太网数据包</p>
<h3 id="chap10">chap10、邻居子系统<a class="headerlink" href="#chap10" title="Permanent link">&para;</a></h3>
<ul>
<li>邻居是<strong>另一台电脑，还得是同一个局域网</strong></li>
<li>邻居子系统<strong>为IP网络层和网络设备的链路层提供了地址转换有关系</strong>，也就是说它指明了IP地址向MAC地址的转换关系，这其中当然离不开ARP协议，它就是一种<strong>邻居协议</strong></li>
<li><code>struct neigh_table{};</code>，<strong>描述了邻居协议的参数和函数表</strong>，内核中的arp_tbl就是ARP的邻居表结构</li>
</ul>
<h4 id="101">10.1、邻居子系统的初始化<a class="headerlink" href="#101" title="Permanent link">&para;</a></h4>
<ul>
<li><code>inet_init()</code>里面调用了<code>arp_init()</code></li>
</ul>
<h4 id="102">10.2、查找邻居结构<a class="headerlink" href="#102" title="Permanent link">&para;</a></h4>
<ul>
<li>/net/core/neighbour.c中的<code>neigh_lookup()</code></li>
</ul>
<h4 id="103">10.3、邻居子系统的发送事件<a class="headerlink" href="#103" title="Permanent link">&para;</a></h4>
<ul>
<li><code>neigh_resolve_output()</code></li>
</ul>
<h4 id="104">10.4、邻居子系统的接收处理<a class="headerlink" href="#104" title="Permanent link">&para;</a></h4>
<ul>
<li>先是对ARP头部进行检查，确定无误后最后调用<code>arp_process()</code></li>
</ul>
<h3 id="chap11">chap11、流量控制<a class="headerlink" href="#chap11" title="Permanent link">&para;</a></h3>
<h4 id="111">11.1、排队规则的初始化<a class="headerlink" href="#111" title="Permanent link">&para;</a></h4>
<ul>
<li>Qdisc（Queueing discipline）</li>
<li><code>struct Qdisc{};</code>结构体定义</li>
<li>网卡，drivers/net目录下的dm9000.c为例 【<em>pci设备先不管</em>（r8169.c）】<ul>
<li>初始化函数<code>dm9000_probe()</code>，再注册<code>register_netdev(ndev);</code></li>
</ul>
</li>
<li>qdisc的“安装”过程函数，net/sched/sch_generic.c中<code>dev_init_scheduler()</code><ul>
<li><code>dev-&gt;qdisc = &amp;noop_qdisc;//初始设置排隐规则结构</code>，<strong>这是个结构体</strong>，里面挂入了<strong>出队、入队函数</strong></li>
</ul>
</li>
<li><code>ifconfig eth0 up</code>启动过程<ul>
<li><code>ioctl()-&gt;sock_ioctl()-&gt;dev_ioctl()-&gt;SIOCSIFFLAGS-&gt;dev_ifsioc()-&gt;dev_change_flags()-&gt;IFF_UP-&gt;dev_open()-&gt;dev_activate()</code><ul>
<li>调用<code>qdisc_create_dflt()</code><ul>
<li>再调用<code>qdisc_alloc()</code></li>
<li>再调用<code>pfifo_fast_init()</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="112">11.2、排队规则的入队和发送<a class="headerlink" href="#112" title="Permanent link">&para;</a></h4>
<ul>
<li>入队，<code>pfifo_fast_enqueue()</code><ul>
<li><code>qdisc_run()</code></li>
</ul>
</li>
<li>发送，<code>qdisc_restart()</code>，<strong>循环调用</strong><ul>
<li><code>struct Qdisc *q = dev-&gt;qdisc;//取得设备的排队规则</code></li>
</ul>
</li>
</ul>
<h3 id="chap12">chap12、建立连接的过程<a class="headerlink" href="#chap12" title="Permanent link">&para;</a></h3>
<ul>
<li>第9章</li>
<li>本章分析，服务器如何为数据块建立数据包并从底层（链路层）向上层（应用层）传递到服务器程序的过程</li>
</ul>
<h4 id="121">12.1、驱动程序接收并建立数据包<a class="headerlink" href="#121" title="Permanent link">&para;</a></h4>
<ul>
<li>了解驱动程序是如何将中断程序登记到内核中的。CS8900驱动程序中的<code>cs89x0_probel()</code></li>
<li>当使用ifconfig eth0 up启动网卡时会执行系统调用<code>sys_ioctl()</code>，最终内核会执行<code>dev_open()</code>，整体过程是，<code>ioctl()-&gt;sock_ioctl()-&gt;dev_ioctl()-&gt;SIOCSIFFILAGS-&gt;dev_ifsioc()-&gt;dev_change_flags()-&gt;IFF_UP-&gt;dev_open()</code></li>
<li>Linux内核中有一个网络软中断数据结构<code>softnet_data</code></li>
</ul>
<h4 id="122">12.2、查找数据包类型且调用其处理函数<a class="headerlink" href="#122" title="Permanent link">&para;</a></h4>
<ul>
<li>最终目标是，<code>do_softirq()-&gt;net_rx_action()-&gt;process_backlog()-&gt;netif_receive_skb()</code></li>
</ul>
<h4 id="123ip">12.3、接收或转发IP数据包<a class="headerlink" href="#123ip" title="Permanent link">&para;</a></h4>
<ul>
<li><code>ip_rcv()</code>最后通过NF_HOOK宏转入<code>ip_rcv_finish()</code>，这个函数有两方面的使用：<ul>
<li>一是明确数据包是本地接收还是转发，如果是转发就需要进一步明确转发网络设备和跳转出口</li>
<li>二是分析和处理关于IP选项的内容</li>
<li>在<code>/net/ipv4/ip_input.c</code></li>
<li>整个过程，<code>do_softirq()-&gt;net_rx_action()-&gt;process_backlog()-&gt;netif_receive_skb()-&gt;deliver_skb()-&gt;ip_rcv()-&gt;ip_rcv_finish()</code></li>
</ul>
</li>
</ul>
<h4 id="124tcp">12.4、TCP数据包的处理<a class="headerlink" href="#124tcp" title="Permanent link">&para;</a></h4>
<ul>
<li>无论是重组后的数据包还是直接接收的数据包都要进入<code>ip_local_deliver_finish()</code>交给传输层处理，在/net/ipv4/ip_input.c</li>
<li>整个过程，<code>do_softirq()-&gt;net_rx_action()-&gt;process_backlog()-&gt;</code></li>
</ul>
<h4 id="1253">12.5、3次握手过程<a class="headerlink" href="#1253" title="Permanent link">&para;</a></h4>
<ul>
<li>3次握手过程<ul>
<li>一、client发送一个SYN=1、ACK=0标志的数据包给服务器请求进行连接</li>
<li>二、server收到请求并且允许连接就会发送一个SYN=1、ACK=1标志的数据包给客户端，告诉client可以发送数据了，并让客户端发送一个确认数据包</li>
<li>三、client发送一个SYN=0、ACK=1的数据包给服务器，告诉它连接已被确认</li>
</ul>
</li>
</ul>
<h3 id="chap13internet">chap13、Internet控制信息的传输<a class="headerlink" href="#chap13internet" title="Permanent link">&para;</a></h3>
<ul>
<li>主要关于<strong>错误和请求</strong>的内容</li>
</ul>
<h4 id="131icmp">13.1、发送ICMP信息<a class="headerlink" href="#131icmp" title="Permanent link">&para;</a></h4>
<ul>
<li><code>icmp_send()</code>的过程为例来看Linux是如何使用ICMP协议发送控制信息，在<code>/net/ipv4/icmp.c</code></li>
</ul>
<h4 id="132icmp">13.2、接收ICMP信息<a class="headerlink" href="#132icmp" title="Permanent link">&para;</a></h4>
<ul>
<li>再来看下<code>icmp_rcv()</code>，也在<code>/net/ipv4/icmp.c</code></li>
</ul>
<h3 id="chap14">chap14、数据包的分段与重组<a class="headerlink" href="#chap14" title="Permanent link">&para;</a></h3>
<h4 id="141">14.1、数据包的分段发送<a class="headerlink" href="#141" title="Permanent link">&para;</a></h4>
<h4 id="142">14.2、数据包的分段接收和重组<a class="headerlink" href="#142" title="Permanent link">&para;</a></h4>
<ul>
<li><code>ip_defrag()</code>来看接收重组过程，在<code>/net/ipv4/ip_fragment.c</code>中，<strong><code>ip_defrag()</code>重组完数据后将其传递给TCP层</strong></li>
</ul>
<h4 id="143">14.3、分段数据包的接收队列<a class="headerlink" href="#143" title="Permanent link">&para;</a></h4>
<h4 id="144">14.4、查找与创建分段队列<a class="headerlink" href="#144" title="Permanent link">&para;</a></h4>
<ul>
<li><code>ip_find()</code>，先将数据包头部和来源标志记录到该结构中，然后调用<code>inet_frag_find()</code>在<code>ipv4_frags</code>结构队列中查找INET分段队列头；如果找到了就返回分段队列头指针，反之创建分段队列</li>
</ul>
<h4 id="145">14.5、释放和销毁分段队列<a class="headerlink" href="#145" title="Permanent link">&para;</a></h4>
<ul>
<li><code>ip_evictor()</code></li>
</ul>
<h3 id="chap15">chap15、发送和接收数据包<a class="headerlink" href="#chap15" title="Permanent link">&para;</a></h3>
<h4 id="151">15.1、内核的发送、接收函数<a class="headerlink" href="#151" title="Permanent link">&para;</a></h4>
<h4 id="152">15.2、客户端发送数据包<a class="headerlink" href="#152" title="Permanent link">&para;</a></h4>
<ul>
<li><code>__sock_sendmsg()</code>来分析</li>
</ul>
<h4 id="153">15.3、服务器接收数据包<a class="headerlink" href="#153" title="Permanent link">&para;</a></h4>
<ul>
<li><code>tcp_v4_rcv()</code>如何接收数据包<ul>
<li>首先找到服务器创建的客户端sock结构</li>
</ul>
</li>
</ul>
<h3 id="chap16socket">chap16、socket的关闭<a class="headerlink" href="#chap16socket" title="Permanent link">&para;</a></h3>
<h4 id="161">16.1、内核的关闭函数<a class="headerlink" href="#161" title="Permanent link">&para;</a></h4>
<ul>
<li>关闭服务器的socket过程要比关闭客户端socket复杂</li>
</ul>
<h4 id="162">16.2、服务器与客户端的共同关闭<a class="headerlink" href="#162" title="Permanent link">&para;</a></h4>
<ul>
<li><code>tcp_v4_do_rcv()</code></li>
</ul>
<h3 id="_1">最后<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<h4 id="_2">履历<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<ul>
<li>2023-12-08开始看第1个cubi，<em>主要是觉得用了tc命令后，看到了chpa11</em>想串一下，同时跟《深入理解linux网络》也有知识点交集的地方。</li>
</ul>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
