## 缘起

+ 1、我觉得陈博说得对**要先建立知识框架**，而不是陷入细节里，看paper是这样，看kernel感觉也这样，**要学会自己去建立逻辑性**
+ 2、想着呢，自己看linux tcpip stack的时候呢，看书只是个被迫的过程的话，**如果遇到一个开窍的点，完全可以自己去以此展开，同时再问几个问题，通过问题的方式去建立逻辑性和关联性**
+ 3、初步想法是每周输出一个**技术点**，来自于看书的开窍时刻，再配合一下chatgpt的一些问答
+ 4、2024-03-20，用时44min，22:09-22:53，又差不多是一个cubi

## 内容

### ref点

+ 来自于《LINUX内核源码剖析下册》的chap22-24的3章内容

### 前置知识

+ 看了UNP的话，应该都会知道使用网络编程的一些函数，比如`socket(),accept()`这些，类似于用户态的

#### 1、套接口的定义以及包含哪些函数

+ *这部分，都是之前get到的*

+ 套接口（Socket）是计算机网络中用于实现网络通信的编程接口或抽象层。**应用程序能够通过网络进行数据交换和通信**
+ 套接口**定义了应用程序与网络协议栈之间的接口**，包含了常用函数
  + socket()：创建一个套接字，并返回一个文件描述符，用于后续的操作。
  + bind()：将一个套接字与特定的IP地址和端口号绑定在一起，使其可以接收来自该地址和端口的连接。
  + listen()：将一个套接字设置为监听模式，用于接受传入的连接请求。
  + accept()：接受传入的连接请求，并创建一个新的套接字用于与客户端进行通信。
  + connect()：与远程套接字建立连接，用于客户端应用程序连接到服务器。
  + send()：发送数据到已连接的套接字。
  + recv()：从已连接的套接字接收数据。
  + sendto()：将数据发送到指定的目标地址和端口。
  + recvfrom()：从指定的源地址和端口接收数据。
  + close()：关闭套接字连接。

### 问题

#### 1、套接口层怎么与其上下层衔接   【真正的核心在于proto_ops结构】

+ **图22-1**，也就是 套接口层 **如何将一般的请求转换为指定的协议操作**
+ *本来想截图，用图床上传的，不是太清晰，后面自己用工具画一个吧*
+ 首先上层是**应用程序**，我们一般是调用**库函数** 【问了chatgpt，`socket`不属于库函数】，`read()`和`write()`算是，它们可以读写socket_fd的，*后面会提到socket文件系统**
+ 中间层是**套接口系统调用**，就是（前置知识里的函数）
  + 这个书上22-5，图说得比较明白
  + 从`bind()`到`sys_bind()`这是系统调用，再到`inet_bind()`，*书上有实现细节可以看*  【**这个过程就有proto_ops结构体**】
  + **理解图22-7**bind()调用过程，*自己的流程，没有书上的形象*
    + sys_bind
      + sockfd_lookup_light()
      + sock->ops->bind()->inet_bind()，**这最后一步是proto_ops**
        + 对于RAW，sk->sk_prot->bind()->raw_bind()
        + 对于TCP，sk->sk_prot->get_port()->tcp_v4_get_port()
        + 对于UDP，sk->sk_prot->get_port()->udp_v4_get_port()
  + 参考1：[套接口层之socket系统调用实现](https://blog.csdn.net/xiaoyu_750516366/article/details/83212686)
+ 后面一层是**协议层的4层（传输层）**
  + 4层到3层（网络层），**通过proto结构**

#### 2、哪些重要的数据结构

+ struct socket，**存储与通信有关的信息**
  + https://linux-kernel-labs.github.io/refs/pull/188/merge/labs/networking.html
+ struct proto_ops，**套接口系统调用到传输层函数的跳转表**
  + *这部分，要具体看下实现，目前先了解一下基础知识吧*
+ 数据结构中，**进程、文件描述符，套接口**它们是怎么一个关系
  + stuct task_struct 中的files指向
    + struct file_struct中的`fd_array[]`指向的
      + struct file中的`f_op`，指向了struct file_operations，*这在存储里面学过*
      + struct file中的`private_data`指向了 struct socket
        + struct socket里面的`ops`指向了struct proto_ops
        + struct socket中的sock指向了struct tcp_sock,还是struct upd_sock
  + **还是图22-3**能说明白

#### 3、输入/输出IO靠什么结构体来缓存存数据【msghdr结构】

+ struct msghdr结构
+ 用户态组织数据后，**内核态要不要校验，用什么函数校验**，用verify_iovec()

## 最后

### 总结

+ 1、知道套接口是啥，以及包含哪些
+ 2、套接口层与上层（应用程序）和下层（协议栈）是怎么交互的
+ 3、套接口系统调用的内部实现是如何的，比如要能讲出bind或socket的一些过程
+ 4、一些重要的数据结构，比如socket，proto_ops，能知道它们的功能
+ 5、进程、文件描述符，套接口，它们之间的关系
+ 6、输入/输出IO靠什么结构体来缓存存数据【msghdr结构】
+ 面试一问：socket()算库函数吗？

### 感触

+ *通过这样的方式去学，感觉串得知识更多点，不像之前，只是个摘抄笔记的机器*