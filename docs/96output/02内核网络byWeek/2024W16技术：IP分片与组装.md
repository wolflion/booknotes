## 缘起

+ 这是2024-16W的技术笔记，正好对应《Linux内核源码剖析-tcpip实现(上)》，chap13
+ rfc791，P14/P51有提到
+ **对于分片，没有收全的话，发送ICMP报文**

## 内容

### 1、分片+重组

#### 1.1、分片+重组在协议栈的地位（也就是啥时候需要分片+重组）

+ 一般用于**输入和输出时**
  + `ip_local_deliver()`，该数据包交付给本地应用程序进行进一步处理。
  + `ip_finish_output()`，将数据包发送到下一跳或目标主机，**是IP层输出路径中的最后一个步骤**

+ 1、chap11的第10节，`ip_local_deliver()`，需要先判断收到的包，是不是分片，**重组完成后，才调用它发送**，函数是将数据包交付给本地应用程序
+ 2、`ip_finish_output()`，这里面就有**分片和重组**

#### 1.2、分片的理解

+ 分片：IP层和二层之间（**二层以太网帧，有长度限制**）
+ MTU（maxium transfer unit），1500B，
+ *TCP分片也是在IP层处理的*
+ **对于分片，没有收全的话，发送ICMP报文**

#### 1.3、分片的方式

+ 分快、慢分片，*但为何这么分，没太明白*

##### 1.3.1、快速分片

+ **仅在数据包的首部信息中进行分片，而不对数据包的有效负载进行拆分。**

##### 1.3.2、慢速分片

### 2、ipq结构相关的

#### 2.1、ipq结构体怎么达到hash的？

#### 2.2、v6.8.6代码改变了

+ [inet_frag.h](https://elixir.bootlin.com/linux/v6.8.6/source/include/net/inet_frag.h)
  + `struct inet_frag_queue{}`封装了一下
+ [ip_fragment.c](https://elixir.bootlin.com/linux/v6.8.6/source/net/ipv4/ip_fragment.c)
  + `struct ipq{}`，看这个就很简洁

### 3、分片的负作用，以及如何减少分片

+ 通过路径MTU发现等技术手段来减少分片的需求

## 最后

### 书上讲得存疑

+ 1、TCP不存在分包（*分包应该是 网络层没关系吧，是IP层与2层的事*）

### lwip中的组装怎么查找的？

### 遗留：ipq相关的还没好好看呢