## 《文件系统技术内幕》

### chap1、从文件系统是什么说起

### chap2、如何使用文件系统

#### 2.1、准备开发环境

#### 2.2、读/写文件

#### 2.3、如何遍历目录中的文件

#### 2.4、格式化文件和挂载

+ 格式化，相当于在块设备上创建一个文件系统
+ 挂载，将文件系统激活（在操作系统目录树呈现）的过程

#### 2.5、文件系统与权限管理

#### 2.6、文件系统的锁机制

##### 2.6.1、文件锁的分类与模式

+ 从大类上来分，分为
  + 劝告锁（Advisory Lock）
  + 强制锁（Mandatory Lock）
+ 在**使用上**，无论哪种锁都分为**共享锁和排他锁**两种

##### 2.6.2、Linux文件锁的使用

###### 2.6.2.1、flock()函数的使用简析

+ `int flock(int fd, int operation);`

###### 2.6.2.2、fcntl()函数的使用简析

+ `int fcntl(int fd, int cmd, struct flock *lock);`

#### 2.7、文件系统的扩展属性

+ `getfattr`命令

#### 2.8、文件的零拷贝

##### 2.8.1、零拷贝的基本原理

##### 2.8.2、零拷贝的系统API

+ `sendfile()`，**无法对数据进行修改**
+ `mmap()`

### chap3、本地文件系统原理及核心技术

#### 3.1、Linux文件系统整体架构简介

+ 图3-1

##### 3.1.1、从VFS到具体文件系统

+ 写入数据，函数调用流程

##### 3.1.2、关键处理流程举例

###### 3.1.2.1、文件系统的注册

+ mount()主要作用：**从存储介质读取超级块信息，并创建该文件系统根目录的dentry实例。

###### 3.1.2.2、打开文件的流程

+ （1）如何通过一个字符串路径来打开一个文件？
+ （2）为什么通过一个文件描述符就可以实现文件的访问？
+ 打开文件有2个流程，`do_sys_open()->do_sys_openat2()->do_filp_open()->path_openat()`
  + 流程1：解析：`link_path_walk()->walk_component()->lookup_slow()->inode->i_op->lookup()->ext4_lookup()`
  + 流程2：打开：`do_open()->vfs_open()->do_dentry_open()->f->f_op->open()->ext4_file_open()`

###### 3.1.2.2、挂载文件系统

+ 关键流程：`do_mount()->do_new_mount()->do_new_mount_fc()->do_add_mount()->graft_tree()->attach_recursive_mnt()`

###### 3.1.2.2、读/写数据流程

+ 通过在inode注册的函数指针完成的，函数指针会赋值给file结构体中的成员`f_op`

#### 3.2、本地文件系统的关键技术与特性

##### 3.2.1、磁盘空间布局（Layout）