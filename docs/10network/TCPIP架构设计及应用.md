## 《TCP/IP架构、设计及应用》

### chap17、网络软中断

#### 17.1、使用软中断的原因和触发机制

+ 两个CPU的SMP主机上传输

##### 17.1.1、传输

##### 17.1.2、接收

+ include/linux/interrupt.h中的**支持的软中断**
+ kernel/softirq.c

#### 17.2、处理软中断

+ **软中断在do_softirq()中处理**，kernel/softirq.c中
+ arch/i386/kernel/irq.c中的`do_IRQ()`会调用上面的do_softirq()函数

#### 17.3、软中断的注册

+ net/core/dev.c中的`net_dev_init()`中会有`open_softirq()`的使用，*自己不太熟悉*

#### 17.4、报文接收以及Rx软中断的延迟处理

#### 17.5、网络Rx软中断的处理

#### 17.6、报文传输与软中断

#### 17.7、本章总结

+ Linux2.4支持的软中断
+ 软中断在从中断do_IRQ()返回后执行
+ 软中断可以通过调用local_bh_disable()在本地禁用
+ raise_softirq()是提供在当前CPU上调度软中断的接口
+ softirq_open()是提供注册软中断的接口
+ **softirq_vec是一个类型为softirq_action的数组**

### chap18、报文的传输和接收

+ **网卡支持DMA技术时**，报文的传输和接收，**如何初始化和设计DMA描述符**以收发报文

#### 18.1、传输和接收报文的DMA环缓冲区

+ 初始化
+ 接收时，
+ 传输时，

#### 18.2、报文接收处理

+ Rx中断处理程序在相应CPU的softnet_data数组的一个元素中排队报文（`queue->input_pkt_queue`），该中断通过调用`netif_rx()`产生

##### 18.2.1、DMA支持的报文传输处理过程

##### 18.2.2、环缓冲区的接收处理

#### 18.3、报文传输处理

##### 18.3.1、DMA支持的报文传输处理过程

+ P680，**图18-6**

##### 18.3.2、传输环缓冲区

+ 3个指针管理
  + next
  + first
  + last

#### 18.4、报文传输和接收的实现

##### 18.4.1、struct etrax_eth_descr

##### 18.4.2、struct etrax_dma_descr

##### 18.4.3、设备的初始化

##### 18.4.4、DMA传输环缓冲区的初始化

+ arch/cris/drivers/ethernet.c

##### 18.4.5、DMA接收环缓冲区的初始化

#### 18.5、处理报文接收的Rx中断

##### 18.5.1、Rx DMA缓冲区的初始化

##### 18.5.2、e100_rx()

##### 18.5.3、产生Rx中断前

##### 18.5.4、

#### 18.6、报文传输

##### 18.6.1、e100_send_packet()

+ 为发送帧注册的接口例程

##### 18.6.6、传输了第一个报文并且中断已产生时的情形

#### 18.7、本章总结

+ 除了设置net_device的初始化，**也要初始化网络控制器的Tx和Rx DMA环缓冲区**，当设备打开时，**要向内核注册DMA内存分配、IRQ号和中断处理程序**