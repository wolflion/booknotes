### 缘起

+ 《深入理解Linux网络技术内幕》Part5
  + chap26、概念
  + chap27、基本结构，neighbour.h
  + chap28、ARP
  + chap29、其它
+ 《LINUX内核源码剖析》上册
  + chap17、邻居子系统
  + chap18、ARP

### 二、内容

### 2.1、问在前面的

#### 1、邻居子系统有什么用？为何要单独用一个Part来讲？

+ 扩展去想一下，**什么是邻居？**【邻居这个概念，针对的是几层？】
+ 邻居子系统，**提供了3层与2层之间的映射**，在没有之前，L3**用的是ARP协议**提供的函数
+ 提供了**二层首部缓存**
+ rfc4861，邻居发现协议？

#### 2、一些基础

+ L2层用是**MAC通信**，除了有网卡nic，还有其它网络形式（PPP吧），**L3是大概率是不关心这些细节的**（大部分场景是，也有部分场景相关）
+ MAC与IP的**查找**，就需要了，最开始是ARP，后来叫ND，但整个模块叫**邻居子系统**
+ **邻居**，是同一个局域网内
  + 路由概念里也有邻居的概念，暂时不确定
  + 具体哪些属于邻居，在《深入理解Linux网络技术内幕》的chap26中写了不少场景

#### 3、包含ARP和ND

+ ARP是ipv4的，rfc826
  + *尝试看过原文，没有完全看懂，对照着实现，初步过了一遍*
+ ND是ipv6的，rfc4861
  + *这部分，完全没看，一来呢，自己看的书，代码都相对老一些，没讲，二来呢，rfc826，还没整明白呢*

### 2.2、学到的知识

#### 1、一些结构

+ neigh_table结构

  + 存储**与邻居协议相关的参数、功能函数，以及邻居散列表**，一个实例对一个邻居协议，**所有的实例都链接在全局链表neigh_tables中**
  + *怎么链接呢？*
  + 对于ARP而言，neigh_table的实例就是`arp_tbl`

+ neighbour结构

  + 存储**邻居的相关信息**，包括（状态、二层和三层协议地址、提供给三层协议的函数指针）**一个邻居，并不代表一个主机，而是一个三层协议地址**，对于多接口的主机，就有多三层协议地址
  + *难道真正的关联的是在这里面？*

+ ##### neigh_ops结构

  + 实现了L3与`dev_queue_xmit()`之间的调用桥梁
  + *理解不深*

#### 2、一些功能

+ 初始化
  + arp_init
  + neigh_table_init
+ 邻居项的添加与删除
+ 邻居项的创建与初始化
+ 邻居项散列表的扩容
  + 还是扩hash
+ 邻居项的查找
+ 邻居项的更新
+ 垃圾回收
  + **要把邻居项给清除掉**
  + 有同步和异步

#### 3、额外的重点（可暂时不关注）

+ 邻居项的状态机
  + 以及*整个状态的变化过程*
+ 代理项
  + *我对这个理解得还不深*

### 三、最后

#### 附录

+ [linux网络协议栈分析笔记8-arp邻居子系统1](https://blog.csdn.net/hsly_support/article/details/8790664)
  + 1、arp.c中`struct packet_type`实例化成arp_packet，里面的`fuc=arp_rcv`
  + 2、*如果把arp_packet给注册到packet_type中呢*，这部分没看到过嘛，关键字是`ETH_P_ARP`
  + 3、从`arp_init()`开始就是一些代码流水工作，一步步的那种，思想一下如何把`struct neigh_table`的实例**arp_tbl**给放到全局的**neigh_tables**中
+ [ARP协议与邻居子系统剖析（基于 Linux-2.4.0已更新）](https://www.cnblogs.com/still-smile/p/14932124.html)

#### 收获

+ 东西不算特别多，花点时间，多整几遍，还是能整明白的，还是要先搞主线