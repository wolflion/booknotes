### chap13、TCP协议

#### 13.1、TCP服务简介

+ TCP是2个主机建立连接的关系，应用数据**以数据流的形式**进行传输
+ **UDP运载的是报文**，各个报文在网络中互不相干传输，UDP每收到一个报文就递交给上层应用，*这个时候，是在应用层组装？*

#### 13.2、TCP的特性

##### 13.2.1、连接机制

##### 13.2.2、确认与重传

+ **一个完整的TCP传输必须有数据的交互**，收到数据后必须要正面的确认，发送方必须等接收方的确认，**同时启动一个定时器**，如果超过指定时间，就认为发送失败，然后进行重发操作，这就是**报文重传**

##### 13.2.3、缓冲机制

+ 很多小数据，等一起了再发
+ 发出去的数据不一定能被接收方正确接收，需要等对方收到了再删除，所以也需要缓冲区

##### 13.2.4、全双工通信

+ **TCP连接建立后，那么两个主机就是对等的**
+ TCP协议的确认是**通过捎带的方式**来实现的
+ 任何一方都可以断开连接，但另一个方向上数据仍是连通的状态，这时是**半双工**

##### 13.2.5、流量控制

+ **TCP通过让发送方维护一个称为接收窗口（receive window）的变量**来提供流量控制
+ 接收方为0时，发送方发送只有1个字节的报文段
+ **接收方会告诉发送方，我只能处理这么多**

##### 13.2.6、差错控制

+ **检验和**来检验数据的有效性

##### 13.2.7、拥塞控制

+ **拥塞**，当数据从一个大的管道向一个较小的管道发送时便会发生拥塞。
+ 在**网络中拥塞的情况下调整自身的发送速度**，这种形式对发送方的控制被称为**拥塞控制（congestion control）**

#### 13.3、端口号的概念

#### 13.4、TCP报文段结构

##### 13.4.2、TCP报文段格式`tcp_hdr`

13.5、TCP连接

##### 13.5.1、三次握手

##### 13.5.2、四次挥手

#### 13.6、TCP状态

##### 13.6.1、LwIP中定义的TCP状态`tcp_state_str[]`

##### 13.6.2、TCP状态转移

###### 13.6.2.1、三次握手过程

###### 13.6.2.2、四次挥手过程

#### 13.7、TCP中的数据结构`tcp_pcb`

#### 13.8、窗口的概念

##### 13.8.1、接收窗口

+ rcv_nxt，下次期望接收到的数据编号
+ rcv_wnd，接收窗口的大小
+ rcv_ann_wnd，告诉发送方窗口的大小
+ rcv_ann_right_edge，记录了窗口的右边界
+ **这4个成员变量都会在数据传输的过程中动态改变的**

##### 13.8.2、发送窗口

+ lastack，已经确认的最大序号
+ snd_nxt，下次要发送的序号
+ snd_lbb，下一个将被应用线程缓冲的序号
+ snd_wnd，发送窗口的大小，由接收方提供
+ **动态变化**

#### 13.9、TCP报文段处理

##### 13.9.1、报文段缓冲队列`tcp_seg`

##### 13.9.2、TCP报文段发送`tcp_output`

##### 13.9.3、TCP报文段接收`tcp_input`